import logging
import sys
from pathlib import Path
from algosdk.atomic_transaction_composer import transaction
from beaker import sandbox
from asas.nfts.arcs import arc3, arc19
import json
from dotenv import load_dotenv


logging.basicConfig(level=logging.DEBUG, format="%(asctime)s %(levelname)-10s: %(message)s")
logger = logging.getLogger(__name__)
logger.info("Loading .env")
load_dotenv()
root_path = Path(__file__).parent


def main(action: str) -> None:
    client = sandbox.get_algod_client()
    accts = sandbox.get_accounts()
    acct_sender = accts.pop()  # Replace by your address

    # ---------INPUT--------- #

    metadata_file = "asas/nfts/metadata.json"
    folder_image = "asas/nfts/Collections/Images/"
    folder_json = "asas/nfts/Collections/Metadata/"
    unitname_prefix = "ALGO"  # UnitName (eg for 1 file : ALGO ->  ALGO0001)
    sender = acct_sender.address
    manager = acct_sender.address
    reserve = acct_sender.address
    upload_ipfs = True
    pk_sender = acct_sender.private_key
    match action:
        case "immutable":
            logger.info(f"Create immutable NFT collection")
            with open(metadata_file, "r") as f:
                nfts_metadata = json.load(f)
            arc3.upload_ipfs(folder_image, folder_json, nfts_metadata, upload_ipfs)
            txns = arc3.create_acgf_txn(client, nfts_metadata, folder_json, unitname_prefix, sender, manager, reserve)

            for txn in txns:
                txid = client.send_transaction(txn.sign(pk_sender))
                res = transaction.wait_for_confirmation(client, txid, 4)
                print(f"Immutable ARC-3 NFT Created, Asset ID: {res['asset-index']}")

        case "mutable":
        logger.info(f"Create mutable NFT collection")
            with open(metadata_file, "r") as f:
                nfts_metadata = json.load(f)
            arc3.upload_ipfs(folder_image, folder_json, nfts_metadata, upload_ipfs)
            txns = arc19.create_acgf_txn(client, nfts_metadata, folder_json, unitname_prefix, sender, manager)

            for txn in txns:
                txid = client.send_transaction(txn.sign(pk_sender))
                res = transaction.wait_for_confirmation(client, txid, 4)
                print(f"Mutable ARC-19 NFT Created, Asset ID: {res['asset-index']}")


if __name__ == "__main__":
    if len(sys.argv) > 1:
        main(sys.argv[1])
    else:
        logger.info(f"Please select mutable or immutable")
